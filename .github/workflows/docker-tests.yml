name: Docker Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  docker-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env file
      run: |
        cat > .env << EOF
        QDRANT_HOST=qdrant
        QDRANT_PORT=6333
        COLLECTION_NAME=wikipedia_pt
        OLLAMA_HOST=ollama
        OLLAMA_PORT=11434
        LLM_MODEL=qwen2.5:7b
        EMBEDDING_MODEL=paraphrase-multilingual-MiniLM-L12-v2
        EMBEDDING_SIZE=384
        API_PORT=9000
        CHUNK_SIZE=500
        CHUNK_OVERLAP=50
        EOF

    - name: Start services with Docker Compose
      run: |
        docker compose up -d
        echo "Waiting for services to be ready..."

    - name: Wait for Qdrant
      run: |
        echo "Waiting for Qdrant..."
        for i in {1..30}; do
          if curl -f http://localhost:6333/health 2>/dev/null; then
            echo "Qdrant is ready!"
            break
          fi
          echo "Waiting for Qdrant... attempt $i/30"
          sleep 2
        done

    - name: Wait for Ollama
      run: |
        echo "Waiting for Ollama..."
        for i in {1..30}; do
          if curl -f http://localhost:11434/api/tags 2>/dev/null; then
            echo "Ollama is ready!"
            break
          fi
          echo "Waiting for Ollama... attempt $i/30"
          sleep 2
        done

    - name: Wait for App
      run: |
        echo "Waiting for App..."
        for i in {1..30}; do
          if docker compose logs app | grep -q "Uvicorn running"; then
            echo "App is ready!"
            break
          fi
          echo "Waiting for App... attempt $i/30"
          sleep 2
        done

    - name: Check services health
      run: |
        echo "=== Docker Compose Status ==="
        docker compose ps
        echo ""
        echo "=== App Logs ==="
        docker compose logs --tail=50 app
        echo ""
        echo "=== Qdrant Health ==="
        curl -f http://localhost:6333/health || echo "Qdrant not responding"
        echo ""
        echo "=== Ollama Status ==="
        curl -f http://localhost:11434/api/tags || echo "Ollama not responding"

    - name: Run tests in Docker
      run: |
        docker exec offline_wikipedia_app python -m pytest tests/ -v --cov=api --cov=services --cov-report=term-missing --tb=short

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== All Container Logs ==="
        docker compose logs
        echo ""
        echo "=== Docker Process Status ==="
        docker ps -a

    - name: Stop services
      if: always()
      run: docker compose down -v
