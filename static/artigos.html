<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Base de Conhecimento - Artigos</title>
    <link rel="stylesheet" href="/static/css/artigos.css">
</head>
<body>
    <div style="width:100%;background:#4F6EF7;padding:10px 0;display:flex;justify-content:space-between;align-items:center;">
        <a href="/static/landing.html" class="top-btn">Ir para Landing Page</a>
        <div id="qdrant-collections-top" style="margin-right:32px;">
            <label for="qdrant-collections-dropdown" style="color:#fff;font-weight:bold;margin-right:8px;">Cole√ß√µes Qdrant:</label>
            <select id="qdrant-collections-dropdown" style="padding:6px 12px;border-radius:6px;font-size:1em;min-width:220px;"></select>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h1>üìö Base de Conhecimento</h1>
                    <p>Explore e busque artigos da Wikipedia na base vetorial</p>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="window.location.href='/'">üè† Voltar</button>
                        <button class="btn btn-secondary" onclick="carregarArtigos()">üîÑ Atualizar</button>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;min-width:340px;width:100%;">
                    <div class="stat-card" style="width:100%;min-width:320px;max-width:100%;padding:18px 24px;box-sizing:border-box;">
                        <div style="margin-bottom:10px;display:flex;align-items:center;width:100%;">
                            <span class="stat-label" style="font-size:0.92em;color:#667eea;font-weight:600;width:140px;display:inline-block;text-align:left;">üîó Modelo de Embeddings</span>
                            <span class="stat-value" id="embeddingModel" style="font-size:0.82em;color:#222;text-align:left;flex-grow:1;">-</span>
                        </div>
                        <div style="margin-bottom:10px;display:flex;align-items:center;width:100%;">
                            <span class="stat-label" style="font-size:0.92em;color:#667eea;font-weight:600;width:140px;display:inline-block;text-align:left;">üìè Dimens√µes</span>
                            <span class="stat-value" id="embeddingDim" style="font-size:0.82em;color:#222;text-align:left;flex-grow:1;">-</span>
                        </div>
                        <div style="display:flex;align-items:center;width:100%;">
                            <span class="stat-label" style="font-size:0.92em;color:#667eea;font-weight:600;width:140px;display:inline-block;text-align:left;">üìù Descri√ß√£o</span>
                            <span class="stat-value" id="embeddingDescricao" style="font-size:0.82em;color:#222;text-align:left;flex-grow:1;">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-value" id="totalArtigos">-</span>
                <span class="stat-label">üìö Total de Artigos</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="totalChunks">-</span>
                <span class="stat-label">üì¶ Total de Chunks</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="artigosFiltrados">-</span>
                <span class="stat-label" id="labelFiltrados">üîç Filtrando</span>
            </div>
        </div>

        <div class="search-box">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="üîç Buscar artigos por palavra-chave..." 
                oninput="filtrarArtigos()"
            >
            <div class="filters">
                <button class="filter-btn" onclick="mostrarTodos(event)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">üìö Ver Todos</button>
                <button class="filter-btn active" onclick="ordenar('alfabetica', event)">A-Z</button>
                <button class="filter-btn" onclick="ordenar('chunks', event)">Mais Chunks</button>
                <button class="filter-btn" onclick="ordenar('recentes', event)">Mais Recentes</button>
            </div>
        </div>

        <div id="loadingContainer" class="loading">
            <div>‚è≥ Carregando artigos...</div>
        </div>

        <div id="articlesContainer" class="articles-grid" style="display: none;"></div>

        <div id="pagination" class="pagination" style="display: none;">
            <button class="pagination-btn" id="prevBtn" onclick="irParaPagina(paginaAtual - 1)">
                ‚Üê Anterior
            </button>
            <div class="pagination-info">
                <span id="paginacaoTexto">P√°gina 1 de 1</span>
            </div>
            <button class="pagination-btn" id="nextBtn" onclick="irParaPagina(paginaAtual + 1)">
                Pr√≥xima ‚Üí
            </button>
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            <div class="no-results-icon">üîç</div>
            <h2>Nenhum artigo encontrado</h2>
            <p>Tente buscar com outras palavras-chave</p>
        </div>
    </div>

    <!-- Modal para detalhes do artigo -->
    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="close-btn" onclick="fecharModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { loadQdrantCollections, loadModeloEmbeddings } from '/static/js/main.js';

        document.addEventListener('DOMContentLoaded', () => {
            const dropdown = document.getElementById('qdrant-collections-dropdown');
            const savedCollection = localStorage.getItem('selectedCollection');
            loadQdrantCollections(dropdown, savedCollection).then(() => {
                carregarArtigos();
            });
            dropdown.addEventListener('change', function() {
                if (dropdown.value) {
                    localStorage.setItem('selectedCollection', dropdown.value);
                }
                carregarArtigos();
            });
        });
        // Configura√ß√£o da API
        const API_BASE = window.location.origin;
        
        let todosArtigos = [];
        let artigosFiltrados = [];
        let ordenacaoAtual = 'alfabetica';
        
        // Configura√ß√£o de pagina√ß√£o
        const ARTIGOS_POR_PAGINA = 50;
        let paginaAtual = 1;
        let totalPaginas = 1;

        // N√ÉO carregar artigos automaticamente - apenas ao buscar/filtrar
        window.addEventListener('DOMContentLoaded', () => {
            // Carregar metadados mas n√£o exibir artigos
            carregarMetadados();
        });

        async function carregarMetadados() {
            const loading = document.getElementById('loadingContainer');
            
            loading.style.display = 'block';
            loading.innerHTML = '<div>‚è≥ Carregando base de conhecimento...</div>';

            try {
                const response = await fetch(`${API_BASE}/artigos`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                todosArtigos = data.artigos || [];
                artigosFiltrados = []; // N√£o filtrar nada inicialmente
                
                document.getElementById('totalArtigos').textContent = data.total || 0;
                document.getElementById('totalChunks').textContent = data.total_chunks || 0;
                document.getElementById('artigosFiltrados').textContent = 0;
                
                loading.style.display = 'none';
                document.getElementById('articlesContainer').innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"><p style="font-size: 1.3em; color: #667eea; font-weight: 600;">üîç Use a busca acima para encontrar artigos</p><p style="color: #999; margin-top: 10px;">Digite palavras-chave para filtrar os artigos da base</p></div>';
                document.getElementById('articlesContainer').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar metadados:', error);
                loading.innerHTML = '<div style="color: #ff4444;">‚ùå Erro ao carregar base de conhecimento</div>';
            }
        }

        async function carregarArtigos() {
            const loading = document.getElementById('loadingContainer');
            const container = document.getElementById('articlesContainer');
            const noResults = document.getElementById('noResults');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            noResults.style.display = 'none';

            try {
                // Obt√©m cole√ß√£o selecionada do localStorage
                let colecao = localStorage.getItem('selectedCollection') || '';
                // Se vier via query string, prioriza
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('colecao')) {
                    colecao = urlParams.get('colecao');
                }
                let endpoint = `${API_BASE}/artigos`;
                if (colecao) {
                    endpoint += `?colecao=${encodeURIComponent(colecao)}`;
                }
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                todosArtigos = data.artigos || [];
                artigosFiltrados = [...todosArtigos];
                document.getElementById('totalArtigos').textContent = data.total || 0;
                document.getElementById('totalChunks').textContent = data.total_chunks || 0;

                const responseColecao = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const modeloEmbedding = await loadModeloEmbeddings(colecao)

                document.getElementById('embeddingModel').textContent = modeloEmbedding.modelo_embedding_nome;
                document.getElementById('embeddingDim').textContent = modeloEmbedding.modelo_embedding_dimensoes;
                document.getElementById('embeddingDescricao').textContent = modeloEmbedding.modelo_embedding_descricao || '-';
                ordenar(ordenacaoAtual);
                renderizarArtigos();
            } catch (error) {
                console.error('Erro ao carregar artigos:', error);
                loading.innerHTML = '<div style="color: #ff4444;">‚ùå Erro ao carregar artigos</div>';
            }
        }

        function filtrarArtigos() {
            const busca = document.getElementById('searchInput').value.toLowerCase();
            
            if (!busca.trim()) {
                // Se busca vazia, limpar filtros e voltar ao estado inicial
                artigosFiltrados = [];
                document.getElementById('articlesContainer').innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"><p style="font-size: 1.3em; color: #667eea; font-weight: 600;">üîç Use a busca acima ou clique em "üìö Ver Todos"</p><p style="color: #999; margin-top: 10px;">Digite palavras-chave para filtrar os artigos da base</p></div>';
                document.getElementById('articlesContainer').style.display = 'block';
                document.getElementById('artigosFiltrados').textContent = 0;
                document.getElementById('labelFiltrados').textContent = 'üîç Filtrando';
                document.getElementById('pagination').style.display = 'none';
                return;
            } else {
                artigosFiltrados = todosArtigos.filter(artigo => {
                    return artigo.title.toLowerCase().includes(busca) ||
                           artigo.preview.toLowerCase().includes(busca);
                });
            }
            
            paginaAtual = 1; // Resetar para primeira p√°gina ao filtrar
            renderizarArtigos();
        }

        function irParaPagina(pagina) {
            if (pagina < 1 || pagina > totalPaginas) return;
            paginaAtual = pagina;
            renderizarArtigos();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function atualizarPaginacao() {
            totalPaginas = Math.ceil(artigosFiltrados.length / ARTIGOS_POR_PAGINA);
            
            const paginacao = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const paginacaoTexto = document.getElementById('paginacaoTexto');
            
            if (totalPaginas <= 1) {
                paginacao.style.display = 'none';
            } else {
                paginacao.style.display = 'flex';
                prevBtn.disabled = paginaAtual === 1;
                nextBtn.disabled = paginaAtual === totalPaginas;
                paginacaoTexto.textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
            }
        }

        function mostrarTodos(event) {
            // Limpar busca
            document.getElementById('searchInput').value = '';
            
            // Mostrar todos os artigos
            artigosFiltrados = [...todosArtigos];
            
            // Aplicar ordena√ß√£o atual
            ordenar(ordenacaoAtual, null);
            
            // Atualizar UI
            document.getElementById('artigosFiltrados').textContent = artigosFiltrados.length;
            document.getElementById('labelFiltrados').textContent = '‚úÖ Mostrando';
            
            // Resetar para primeira p√°gina
            paginaAtual = 1;
            renderizarArtigos();
            
            // Destacar bot√£o "Ver Todos"
            if (event) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.textContent.includes('Ver Todos')) {
                        btn.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            btn.style.transform = 'scale(1)';
                        }, 200);
                    }
                });
            }
        }

        function ordenar(tipo, event) {
            ordenacaoAtual = tipo;
            
            // Atualizar bot√µes ativos (se chamado via clique)
            if (event) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            switch(tipo) {
                case 'alfabetica':
                    artigosFiltrados.sort((a, b) => a.title.localeCompare(b.title, 'pt-BR'));
                    break;
                case 'chunks':
                    artigosFiltrados.sort((a, b) => b.chunks - a.chunks);
                    break;
                case 'recentes':
                    artigosFiltrados.sort((a, b) => {
                        const dateA = new Date(a.timestamp || 0);
                        const dateB = new Date(b.timestamp || 0);
                        return dateB - dateA;
                    });
                    break;
            }
            
            renderizarArtigos();
        }

        function renderizarArtigos() {
            const loading = document.getElementById('loadingContainer');
            const container = document.getElementById('articlesContainer');
            const noResults = document.getElementById('noResults');
            
            loading.style.display = 'none';
            
            document.getElementById('artigosFiltrados').textContent = artigosFiltrados.length;
            document.getElementById('labelFiltrados').textContent = artigosFiltrados.length > 0 ? '‚úÖ Encontrados' : 'üîç Filtrando';
            
            if (artigosFiltrados.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            container.style.display = 'grid';
            noResults.style.display = 'none';
            
            // Calcular artigos da p√°gina atual
            const inicio = (paginaAtual - 1) * ARTIGOS_POR_PAGINA;
            const fim = inicio + ARTIGOS_POR_PAGINA;
            const artigosPagina = artigosFiltrados.slice(inicio, fim);
            
            // Atualizar pagina√ß√£o
            atualizarPaginacao();
            
            container.innerHTML = artigosPagina.map(artigo => `
                <div class="article-card" onclick="abrirArtigo('${artigo.url}', '${escapeHtml(artigo.title)}')">
                    <div class="article-title">
                        üìÑ ${escapeHtml(artigo.title)}
                    </div>
                    <div class="article-preview">
                        ${escapeHtml(artigo.preview)}...
                    </div>
                    <div class="article-meta">
                        <span class="article-chunks">${artigo.chunks} chunks</span>
                        ${artigo.url ? `<a class="article-link" href="${artigo.url}" target="_blank" onclick="event.stopPropagation()">üîó ${escapeHtml(artigo.title)}</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function abrirArtigo(url, titulo) {
            if (url) {
                window.open(url, '_blank');
            }
        }

        function fecharModal() {
            document.getElementById('articleModal').classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fechar modal ao clicar fora
        document.getElementById('articleModal').addEventListener('click', (e) => {
            if (e.target.id === 'articleModal') {
                fecharModal();
            }
        });
    </script>
</body>
</html>
